# simple-artifact-builder pnpm symlink resolution issue

## Problem

When using pnpm, `simple-artifact-builder` fails to properly resolve symlinked dependencies, causing Lambda runtime errors like:

```
Cannot find module '@hapi/hoek/lib/assert'
Require stack:
- /var/task/node_modules/joi/lib/index.js
```

## Root Cause

pnpm uses a content-addressable store with symlinks:

```
node_modules/joi -> .pnpm/joi@17.4.0/node_modules/joi
node_modules/.pnpm/joi@17.4.0/node_modules/@hapi/hoek -> ../../../@hapi+hoek@9.3.0/node_modules/@hapi/hoek
```

When `joi/lib/index.js` requires `@hapi/hoek/lib/assert`, Node.js resolves this via:
1. Look in `node_modules/.pnpm/joi@17.4.0/node_modules/@hapi/hoek` (symlink)
2. Follow symlink to `node_modules/.pnpm/@hapi+hoek@9.3.0/node_modules/@hapi/hoek`

The artifact builder correctly:
- Copies `node_modules/joi/` (dereferenced from symlink)
- Copies `node_modules/.pnpm/joi@17.4.0/node_modules/@hapi/hoek/` (dereferenced)

But the deployed Lambda fails because:
- `node_modules/joi/lib/index.js` requires `@hapi/hoek/lib/assert`
- Node.js looks for `node_modules/@hapi/hoek/` (relative to joi's location)
- This path doesn't exist in the artifact - only the `.pnpm/` paths exist

## Solution

`simple-artifact-builder` needs to ensure that when tracing dependencies from pnpm's `.pnpm/` structure, the **root-level symlinks** (e.g., `node_modules/@hapi/hoek`) are also dereferenced and included.

### Option A: Dereference all root symlinks for traced deps

When a dependency like `@hapi/hoek` is traced, also check if there's a corresponding symlink at `node_modules/@hapi/hoek` and include the dereferenced content there.

### Option B: Use pnpm's node-linker=hoisted mode

Configure pnpm to use `node-linker=hoisted` in `.npmrc`, which creates a flat `node_modules` structure like npm/yarn. This is a workaround, not a fix.

### Option C: Add pick patterns (workaround)

In `artifact.yml`, explicitly pick the missing root-level dependencies:

```yaml
pick:
  - 'node_modules/@hapi/**/*'
  - 'node_modules/@sideway/**/*'
```

This works but requires manual maintenance when dependencies change.

## Recommended Fix

Option A is the correct fix for `simple-artifact-builder`. When tracing produces a path like:
```
node_modules/.pnpm/joi@17.4.0/node_modules/@hapi/hoek/lib/assert.js
```

The builder should recognize this is a pnpm structure and also include:
```
node_modules/@hapi/hoek/ -> (dereferenced content)
```

This ensures Node.js module resolution works correctly in the deployed Lambda.
